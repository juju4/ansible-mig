---
## NOK too many dependencies
#- name: download wixl for windows agent packaging
#  get_url: url=http://ftp.gnome.org/pub/GNOME/sources/msitools/0.95/msitools-0.95.tar.xz dest=/root/msitools-0.95.tar.xz

## FIXME! globbing not working = ignore_errors
- stat: path="{{ mig_src }}/mig-agent_*.deb"
  register: migagentpkg1
#- debug: var=migagentpkg1
- name: Build MIG platform agent packages - deb
  command: "make deb-agent chdir={{ mig_src }}"
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/bin"
    GOPATH: "{{ mig_gopath }}"
    BUILDENV: prod
  become: yes
  become_user: "{{ mig_user }}"
  when: not migagentpkg1.stat.exists
  ignore_errors: true
- stat: path="{{ mig_src }}/mig-agent_*.rpm"
  register: migagentpkg2
- name: Build MIG platform agent packages - rpm
  command: "make rpm-agent chdir={{ mig_src }}"
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/bin"
    GOPATH: "{{ mig_gopath }}"
    BUILDENV: prod
  become: yes
  become_user: "{{ mig_user }}"
  when: not migagentpkg2.stat.exists
  ignore_errors: true
#    - "make dmg-agent"     ## only on MacOS
#    - "make msi-agent"     ## Need wixl/no package before wily
- stat: path="{{ mig_src }}/bin/linux/amd64/mig-agent-latest.exe"
  register: migagentbin2
## FIXME! fails silently
- name: Build MIG platform cross-platform agent
#  command: "make mig-agent msi-agent chdir={{ mig_src }}"
  command: "make mig-agent chdir={{ mig_src }}"
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/usr/local/go/bin:/usr/local/bin"
    GOPATH: "{{ mig_gopath }}"
    BUILDENV: prod
    OS: windows
    ARCH: amd64
  become: yes
  become_user: "{{ mig_user }}"
  when: not migagentbin2.stat.exists

#- name: retrieve mig-agent to deploy? what about libraries? (vdso, pthread, c)
#  fetch: src="{{ mig_src }}/bin/linux/amd64/mig-agent-latest" dest=migagent flat=yes

