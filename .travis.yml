---
## Enable trusty beta
#sudo: required
dist: trusty
## Reminder: Travis test only valid on Ubuntu12.04, 14.04 in testing, Centos through docker (leave it to kitchen...)
language: python
python: "2.7"
before_install:
 - sudo apt-get update -qq
 - sudo apt-get install -qq python-apt python-pycurl
## dependencies
 - git clone https://github.com/juju4/ansible-adduser.git ../adduser
 - git clone https://github.com/juju4/ansible-gpgkey_generate.git ../gpgkey_generate
 - git clone https://github.com/juju4/ansible-playbook-rabbitmq.git ../Mayeu.RabbitMQ
 - ln -s ansible-mig ../mig
## for local travis execution as we use same default.yml than kitchen
 - mkdir /tmp/kitchen
 - ln -s /home/travis/build/juju4/ansible-mig/test/integration/default/tmp /tmp/kitchen/tmp
## serverspec test
 - sudo apt-get install -qq ruby2.0 rake
 - sudo gem2.0 install serverspec rspec
 - ln -s /home/travis/build/juju4/ansible-mig/test/integration/default/serverspec/Rakefile /home/travis/build/juju4/ansible-mig/
install:
  - pip install ansible
  - ansible --version
  - "{ echo '[defaults]'; echo 'roles_path = ../'; } >> ansible.cfg"
  - cat ansible.cfg
  - gem2.0 --version
script:
  - "echo localhost > inventory"

# Check the role/playbook's syntax.
  - "ansible-playbook -i inventory --syntax-check test/integration/default/default.yml"

# Run the role/playbook with ansible-playbook.
  - "ansible-playbook -i inventory --connection=local --sudo -vvvv test/integration/default/default.yml"

## Run the role/playbook again, checking to make sure it's idempotent. = Known issue
  - "ansible-playbook -i inventory test/integration/default/default.yml --connection=local --sudo | tee /tmp/idempotency.log | grep -q 'changed=0.*failed=0'  && (echo 'Idempotence test: pass' && exit 0)  || (echo 'Idempotence test: fail' && cat /tmp/idempotency.log && exit 0)"

# serverspec
## FIXME! LoadError: cannot load such file -- rspec/core/rake_task
  - "cd /home/travis/build/juju4/ansible-mig/ && rake2.0 --trace spec; exit 0"

